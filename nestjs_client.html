<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NestJS Full Stack Demo</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        h2 {
            color: #667eea;
            margin-bottom: 20px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        h3 {
            color: #764ba2;
            margin: 15px 0 10px 0;
        }
        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }
        .status.connected { background: #4ade80; color: white; }
        .status.disconnected { background: #f87171; color: white; }
        .status.authenticated { background: #3b82f6; color: white; }
        input, textarea, button, select {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
        }
        input[type="file"] { padding: 8px; }
        textarea { resize: vertical; min-height: 80px; }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s;
        }
        button:hover { transform: translateY(-2px); }
        button:active { transform: translateY(0); }
        button.danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        button.secondary {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        }
        .messages, .list {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            background: #f9fafb;
        }
        .message, .item {
            background: white;
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .message-author, .item-title {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        .message-time, .item-meta {
            font-size: 0.8em;
            color: #6b7280;
            margin-left: 10px;
        }
        .typing {
            color: #667eea;
            font-style: italic;
            margin: 10px 0;
        }
        .info {
            background: #dbeafe;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            color: #1e40af;
            font-size: 0.9em;
        }
        .success {
            background: #d1fae5;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            color: #065f46;
        }
        .error {
            background: #fee2e2;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            color: #991b1b;
        }
        .auth-info {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        @media (max-width: 1024px) {
            .grid { grid-template-columns: 1fr; }
            .btn-group { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <h1>üöÄ NestJS Full Stack Demo</h1>

    <div class="container">
        <!-- Authentication Section -->
        <div class="section">
            <h2>üîê –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è</h2>
            <div class="auth-info" id="authInfo">
                <strong>–°—Ç–∞—Ç—É—Å:</strong> <span class="status disconnected">–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</span>
            </div>

            <div id="loginForm">
                <h3>–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
                <input type="email" id="authEmail" placeholder="Email">
                <input type="password" id="authPassword" placeholder="–ü–∞—Ä–æ–ª—å">
                <div class="btn-group">
                    <button onclick="login()">üîë –í–æ–π—Ç–∏</button>
                    <button onclick="register()" class="secondary">üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
                </div>
            </div>

            <div id="logoutForm" style="display: none;">
                <button onclick="logout()" class="danger">üö™ –í—ã–π—Ç–∏</button>
            </div>

            <div id="authMessages"></div>
        </div>

        <!-- Messages Section -->
        <div class="grid">
            <div class="section">
                <h2>üí¨ –°–æ–æ–±—â–µ–Ω–∏—è (REST)</h2>
                <div class="info">
                    <strong>–¢—Ä–µ–±—É–µ—Ç—Å—è:</strong> JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è<br>
                    <strong>–≠–Ω–¥–ø–æ–∏–Ω—Ç—ã:</strong> GET/POST/DELETE /api/messages
                </div>

                <textarea id="restMessage" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
                <button onclick="sendRestMessage()">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                <button onclick="loadRestMessages()" class="secondary">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>

                <div class="messages" id="restMessages"></div>
            </div>

            <div class="section">
                <h2>‚ö° –°–æ–æ–±—â–µ–Ω–∏—è (WebSocket)</h2>
                <div class="info">
                    <strong>–°—Ç–∞—Ç—É—Å:</strong> <span class="status disconnected" id="wsStatus">–û—Ç–∫–ª—é—á–µ–Ω</span><br>
                    <strong>–ê–∫—Ç–∏–≤–Ω—ã—Ö:</strong> <span id="userCount">0</span><br>
                    <strong>–¢—Ä–µ–±—É–µ—Ç—Å—è:</strong> JWT —Ç–æ–∫–µ–Ω –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
                </div>

                <textarea id="wsMessage" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeydown="handleTyping()"></textarea>
                <div class="btn-group">
                    <button onclick="sendWsMessage()">‚ö° –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    <button onclick="connectWebSocket()" class="secondary">üîå –ü–æ–¥–∫–ª—é—á–∏—Ç—å</button>
                </div>

                <div class="typing" id="typingIndicator"></div>
                <div class="messages" id="wsMessages"></div>
            </div>
        </div>

        <!-- Files Section -->
        <div class="section">
            <h2>üìÅ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞–º–∏</h2>
            <div class="info">
                <strong>–¢—Ä–µ–±—É–µ—Ç—Å—è:</strong> JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è<br>
                <strong>–≠–Ω–¥–ø–æ–∏–Ω—Ç—ã:</strong> POST /api/files (upload), GET /api/files (—Å–ø–∏—Å–æ–∫ - —Ç–æ–ª—å–∫–æ admin), DELETE /api/files/:id (—Ç–æ–ª—å–∫–æ admin)
            </div>

            <h3>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</h3>
            <input type="file" id="fileInput">
            <button onclick="uploadFile()">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>

            <h3>–°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è admin)</h3>
            <button onclick="loadFiles()" class="secondary">üîÑ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
            <div class="list" id="filesList"></div>
        </div>

        <!-- Users Section -->
        <div class="section">
            <h2>üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h2>
            <div class="info">
                <strong>–¢—Ä–µ–±—É–µ—Ç—Å—è:</strong> JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è<br>
                <strong>–°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö:</strong> —Ç–æ–ª—å–∫–æ admin<br>
                <strong>–°–æ–∑–¥–∞–Ω–∏–µ:</strong> —Ç–æ–ª—å–∫–æ admin<br>
                <strong>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:</strong> –≤–ª–∞–¥–µ–ª–µ—Ü –∏–ª–∏ admin
            </div>

            <h3>–°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (admin)</h3>
            <input type="email" id="newUserEmail" placeholder="Email">
            <input type="password" id="newUserPassword" placeholder="–ü–∞—Ä–æ–ª—å">
            <input type="text" id="newUserName" placeholder="–ò–º—è">
            <select id="newUserRole">
                <option value="user">User</option>
                <option value="admin">Admin</option>
            </select>
            <button onclick="createUser()">‚ûï –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>

            <h3>–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (admin)</h3>
            <button onclick="loadUsers()" class="secondary">üîÑ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
            <div class="list" id="usersList"></div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3003';
        let socket;
        let typingTimeout;
        let accessToken;
        let currentUser;

        // Update auth UI
        function updateAuthUI() {
            // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ localStorage
            try {
                accessToken = localStorage.getItem('accessToken');
                const userStr = localStorage.getItem('user');
                currentUser = (userStr && userStr !== 'undefined' && userStr !== 'null') ? JSON.parse(userStr) : null;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ localStorage:', error);
                accessToken = null;
                currentUser = null;
                localStorage.removeItem('accessToken');
                localStorage.removeItem('user');
            }

            const authInfo = document.getElementById('authInfo');
            const loginForm = document.getElementById('loginForm');
            const logoutForm = document.getElementById('logoutForm');

            if (accessToken && currentUser) {
                authInfo.innerHTML = `
                    <strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong> ${currentUser.name} (${currentUser.email})<br>
                    <strong>–†–æ–ª—å:</strong> ${currentUser.role}<br>
                    <strong>–°—Ç–∞—Ç—É—Å:</strong> <span class="status authenticated">–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</span>
                `;
                loginForm.style.display = 'none';
                logoutForm.style.display = 'block';
            } else {
                authInfo.innerHTML = '<strong>–°—Ç–∞—Ç—É—Å:</strong> <span class="status disconnected">–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</span>';
                loginForm.style.display = 'block';
                logoutForm.style.display = 'none';
            }
        }

        // Register
        async function register() {
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            const messages = document.getElementById('authMessages');

            if (!email || !password) {
                messages.innerHTML = '<div class="error">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è</div>';
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const result = await response.json();
                console.log('Register response:', result);

                if (response.ok) {
                    const token = result.data?.accessToken || result.accessToken;
                    const user = result.data?.user || result.user;

                    if (!token || !user) {
                        messages.innerHTML = '<div class="error">‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞</div>';
                        console.error('Invalid response structure:', result);
                        return;
                    }

                    localStorage.setItem('accessToken', token);
                    localStorage.setItem('user', JSON.stringify(user));
                    updateAuthUI();
                    messages.innerHTML = '<div class="success">‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!</div>';
                    loadRestMessages();
                } else {
                    messages.innerHTML = `<div class="error">‚ùå ${result.message}</div>`;
                }
            } catch (error) {
                messages.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
            }
        }

        // Login
        async function login() {
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            const messages = document.getElementById('authMessages');

            if (!email || !password) {
                messages.innerHTML = '<div class="error">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è</div>';
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const result = await response.json();
                console.log('Login response:', result);

                if (response.ok) {
                    const token = result.data?.accessToken || result.accessToken;
                    const user = result.data?.user || result.user;

                    if (!token || !user) {
                        messages.innerHTML = '<div class="error">‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞</div>';
                        console.error('Invalid response structure:', result);
                        return;
                    }

                    localStorage.setItem('accessToken', token);
                    localStorage.setItem('user', JSON.stringify(user));
                    updateAuthUI();
                    messages.innerHTML = '<div class="success">‚úÖ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω!</div>';
                    loadRestMessages();
                } else {
                    messages.innerHTML = `<div class="error">‚ùå ${result.message}</div>`;
                }
            } catch (error) {
                messages.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
            }
        }

        // Logout
        function logout() {
            accessToken = null;
            currentUser = null;
            localStorage.removeItem('accessToken');
            localStorage.removeItem('user');
            if (socket) socket.disconnect();
            updateAuthUI();
            document.getElementById('authMessages').innerHTML = '<div class="success">‚úÖ –í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã</div>';
        }

        // WebSocket connection
        function connectWebSocket() {
            if (!accessToken) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
                return;
            }

            if (socket) socket.disconnect();

            socket = io(API_URL, {
                auth: { token: accessToken }
            });

            socket.on('connect', () => {
                document.getElementById('wsStatus').textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω';
                document.getElementById('wsStatus').className = 'status connected';
                socket.emit('requestMessages');
            });

            socket.on('disconnect', () => {
                document.getElementById('wsStatus').textContent = '–û—Ç–∫–ª—é—á–µ–Ω';
                document.getElementById('wsStatus').className = 'status disconnected';
            });

            socket.on('userCount', (data) => {
                document.getElementById('userCount').textContent = data.count;
            });

            socket.on('newMessage', (message) => {
                addMessageToWs(message);
            });

            socket.on('allMessages', (messages) => {
                const container = document.getElementById('wsMessages');
                container.innerHTML = '';
                messages.forEach(msg => addMessageToWs(msg));
            });

            socket.on('userTyping', (data) => {
                const indicator = document.getElementById('typingIndicator');
                indicator.textContent = data.isTyping ? `${data.userName} –ø–µ—á–∞—Ç–∞–µ—Ç...` : '';
            });

            socket.on('connect_error', (error) => {
                alert('–û—à–∏–±–∫–∞ WebSocket: ' + error.message);
            });
        }

        // Send message via REST
        async function sendRestMessage() {
            const text = document.getElementById('restMessage').value;
            const token = localStorage.getItem('accessToken');

            if (!text.trim()) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ');
                return;
            }

            if (!token) {
                alert('–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ text })
                });

                if (response.ok) {
                    document.getElementById('restMessage').value = '';
                    await loadRestMessages();
                } else {
                    const error = await response.json();
                    alert('–û—à–∏–±–∫–∞: ' + error.message);
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        // Load REST messages
        async function loadRestMessages() {
            const token = localStorage.getItem('accessToken');
            if (!token) return;

            try {
                const response = await fetch(`${API_URL}/api/messages`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', response.status, response.statusText);
                    return;
                }

                const { data: messages } = await response.json();
                console.log('Loaded messages:', messages);
                const container = document.getElementById('restMessages');
                container.innerHTML = '';

                if (!Array.isArray(messages)) {
                    console.error('Messages is not an array:', messages);
                    return;
                }

                messages.forEach(msg => {
                    const div = document.createElement('div');
                    div.className = 'message';
                    div.innerHTML = `
                        <div class="message-author">
                            ${msg.user?.name || 'Unknown'}
                            <span class="message-time">${new Date(msg.createdAt).toLocaleString()}</span>
                        </div>
                        <div>${msg.text}</div>
                    `;
                    container.appendChild(div);
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
            }
        }

        // Send message via WebSocket
        function sendWsMessage() {
            const text = document.getElementById('wsMessage').value;

            if (!text.trim() || !socket) return;

            socket.emit('sendMessage', { text });
            document.getElementById('wsMessage').value = '';
            socket.emit('typing', { isTyping: false });
        }

        // Add message to WebSocket display
        function addMessageToWs(msg) {
            const container = document.getElementById('wsMessages');
            const div = document.createElement('div');
            div.className = 'message';
            div.innerHTML = `
                <div class="message-author">
                    ${msg.user?.name || 'Unknown'}
                    <span class="message-time">${new Date(msg.createdAt).toLocaleString()}</span>
                </div>
                <div>${msg.text}</div>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        // Handle typing indicator
        function handleTyping() {
            if (!socket) return;

            socket.emit('typing', { isTyping: true });
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                socket.emit('typing', { isTyping: false });
            }, 1000);
        }

        // Upload file
        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];

            if (!file || !accessToken) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch(`${API_URL}/api/files`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${accessToken}` },
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    alert('‚úÖ –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω: ' + result.name);
                    fileInput.value = '';
                } else {
                    const error = await response.json();
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
                }
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        // Load files
        async function loadFiles() {
            if (!accessToken) {
                alert('–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/files`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });

                if (response.ok) {
                    const { data: files } = await response.json();
                    const container = document.getElementById('filesList');
                    container.innerHTML = '';

                    files.forEach(file => {
                        const div = document.createElement('div');
                        div.className = 'item';
                        div.innerHTML = `
                            <div class="item-title">
                                ${file.name}
                                <span class="item-meta">ID: ${file.fileId}</span>
                            </div>
                            <div style="font-size: 0.9em; color: #6b7280;">
                                ${file.path}<br>
                                ${new Date(file.createdAt).toLocaleString()}
                            </div>
                        `;
                        container.appendChild(div);
                    });
                } else {
                    const error = await response.json();
                    alert('‚ùå ' + error.message + ' (—Ç—Ä–µ–±—É–µ—Ç—Å—è —Ä–æ–ª—å admin)');
                }
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        // Create user
        async function createUser() {
            const email = document.getElementById('newUserEmail').value;
            const password = document.getElementById('newUserPassword').value;
            const name = document.getElementById('newUserName').value;
            const role = document.getElementById('newUserRole').value;

            if (!email || !password || !name || !accessToken) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∏ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/users`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({ email, password, name, role })
                });

                if (response.ok) {
                    alert('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω');
                    document.getElementById('newUserEmail').value = '';
                    document.getElementById('newUserPassword').value = '';
                    document.getElementById('newUserName').value = '';
                } else {
                    const error = await response.json();
                    alert('‚ùå ' + error.message);
                }
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        // Load users
        async function loadUsers() {
            if (!accessToken) {
                alert('–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/users`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });

                if (response.ok) {
                    const { data: users } = await response.json();
                    const container = document.getElementById('usersList');
                    container.innerHTML = '';

                    users.forEach(user => {
                        const div = document.createElement('div');
                        div.className = 'item';
                        div.innerHTML = `
                            <div class="item-title">
                                ${user.name}
                                <span class="item-meta">${user.role}</span>
                            </div>
                            <div style="font-size: 0.9em; color: #6b7280;">
                                ${user.email}<br>
                                ID: ${user.userId} | ${user.isActive ? '‚úÖ –ê–∫—Ç–∏–≤–µ–Ω' : '‚ùå –ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}
                            </div>
                        `;
                        container.appendChild(div);
                    });
                } else {
                    const error = await response.json();
                    alert('‚ùå ' + error.message + ' (—Ç—Ä–µ–±—É–µ—Ç—Å—è —Ä–æ–ª—å admin)');
                }
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        // Initialize
        window.onload = () => {
            updateAuthUI();
            if (accessToken) {
                loadRestMessages();
            }
        };
    </script>
</body>
</html>
